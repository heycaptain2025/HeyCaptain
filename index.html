<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarinEkipman - Profesyonel Denizcilik Çözümleri</title>
    
    <!-- Kütüphaneler -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'marine-dark': '#002B49',
                        'marine-blue': '#005F88',
                        'marine-light': '#0088cc',
                        'marine-accent': '#FF6B00',
                        'marine-accent-hover': '#e65a00',
                        'gray-bg': '#f9fafb'
                    },
                    fontFamily: { 'sans': ['Montserrat', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f9fafb; overflow-x: hidden; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .header-curve {
            position: absolute; bottom: -40px; left: 0; width: 100%; height: 80px;
            background-color: #002B49; border-bottom-left-radius: 50% 40px; border-bottom-right-radius: 50% 40px;
            z-index: 10; box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        .logo-area {
            position: absolute; bottom: -60px; left: 50%; transform: translateX(-50%);
            width: 140px; height: 140px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 20; border: 4px solid #f9fafb;
            transition: transform 0.3s ease; cursor: pointer;
        }
        .logo-area:hover { transform: translateX(-50%) scale(1.05); }

        .product-card { 
            background: white; border-radius: 16px; overflow: hidden; transition: all 0.3s ease; 
            border: 1px solid #f3f4f6; position: relative;
        }
        .product-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1); 
            border-color: #0088cc;
        }
        .featured-badge {
            position: absolute; top: 10px; left: 10px; z-index: 5;
            background: linear-gradient(45deg, #FF6B00, #FF8F00); color: white;
            padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .discount-badge {
            position: absolute; top: 10px; right: 10px; z-index: 5;
            background: #ef4444; color: white;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; transform: rotate(15deg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .chat-widget-btn {
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px;
            background: #FF6B00; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 4px 15px rgba(255, 107, 0, 0.4); cursor: pointer; z-index: 50;
            transition: transform 0.2s;
        }
        .chat-widget-btn:hover { transform: scale(1.1); }
        .chat-box {
            position: fixed; bottom: 95px; right: 25px; width: 320px; height: 450px;
            background: white; border-radius: 12px; box-shadow: 0 5px 30px rgba(0,0,0,0.2);
            z-index: 50; display: none; flex-direction: column; overflow: hidden;
            border: 1px solid #e5e7eb; transform-origin: bottom right; animation: chatOpen 0.3s ease-out;
        }
        @keyframes chatOpen { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

        /* Admin Mobile */
        .admin-sidebar { transition: transform 0.3s ease; }
        @media (max-width: 768px) {
            .admin-sidebar { transform: translateX(-100%); position: absolute; z-index: 50; height: 100%; }
            .admin-sidebar.open { transform: translateX(0); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800">

    <!-- ==================== LOGIC LAYER (HYBRID) ==================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. LOCAL DATABASE (HIZ İÇİN) ---
        const defaultLocalData = {
            products: [
                { id: 101, name: "GPSMAP 1223xsv Chartplotter", brand: "Garmin", category: "Elektronik", basePrice: 2800, currency: "USD", stock: 5, img: "https://images.unsplash.com/photo-1557804506-669a67965ba0?w=500", desc: "12 inç ekran, sonar özellikli.", isFeatured: true },
                { id: 102, name: "Sigma Otomatik Can Yeleği", brand: "Lalizas", category: "Güvenlik", basePrice: 120, currency: "EUR", stock: 20, img: "https://images.unsplash.com/photo-1616769911429-1a986eb0712d?w=500", desc: "ISO 12402-3 onaylı.", isFeatured: true },
                { id: 103, name: "Denizci Dürbünü 7x50", brand: "Steiner", category: "Aksesuar", basePrice: 450, currency: "USD", stock: 8, img: "https://images.unsplash.com/photo-1596464716127-f9a08182cb35?w=600", desc: "Su geçirmez profesyonel dürbün.", isFeatured: false },
                { id: 104, name: "Yelkenli Montu", brand: "Helly Hansen", category: "Giyim", basePrice: 3500, currency: "TRY", stock: 15, img: "https://images.unsplash.com/photo-1591047139829-d91aecb6caea?w=500", desc: "Su geçirmez yelken montu.", isFeatured: false }
            ],
            banners: [
                { id: 1, title: "Yeni Sezon Başladı", sub: "Elektronik ürünlerde %20'ye varan indirimler.", img: "https://images.unsplash.com/photo-1566403487332-95b77c5e2366?w=1600" },
                { id: 2, title: "Güvenliğiniz Önceliğimiz", sub: "Lalizas can yeleklerinde kampanya.", img: "https://images.unsplash.com/photo-1621216892641-c7c91722880c?w=1600" }
            ],
            categories: ["Elektronik", "Güvenlik", "Aksesuar", "Giyim", "Motor", "Yelken"],
            campaigns: [
                { id: 1, type: "brand", target: "Garmin", discount: 10, name: "Garmin İndirimi" },
                { id: 2, type: "category", target: "Giyim", discount: 15, name: "Sezon Sonu" }
            ]
        };

        // Local Storage Yükleme
        window.localDB = JSON.parse(localStorage.getItem('marinDB_v4')) || defaultLocalData;
        window.saveLocalDB = () => {
            localStorage.setItem('marinDB_v4', JSON.stringify(window.localDB));
            // Veri değiştiğinde UI güncelle
            window.dispatchEvent(new Event('db-updated'));
        };

        // --- 2. FIREBASE (SADECE CHAT) ---
        window.chatData = [];
        window.currentUserId = localStorage.getItem('marin_uid') || 'u_' + Math.random().toString(36).substr(2,9);
        localStorage.setItem('marin_uid', window.currentUserId);

        const firebaseConfig = {
            apiKey: "AIzaSyDQOMYDJ-MzdYRgs_6eaCRoZi7DFg80wuw",
            authDomain: "marinekipman-978e5.firebaseapp.com",
            projectId: "marinekipman-978e5",
            storageBucket: "marinekipman-978e5.firebasestorage.app",
            messagingSenderId: "775827329954",
            appId: "1:775827329954:web:aace30002bd380f54c98fb"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const chatColl = collection(db, 'artifacts', 'marin-chat-v1', 'messages');

            // Anonim Giriş
            signInAnonymously(auth).then(() => {
                console.log("Chat Bağlantısı Aktif");
                // Mesajları Dinle
                onSnapshot(chatColl, (snap) => {
                    const msgs = snap.docs.map(d => ({id:d.id, ...d.data()}));
                    msgs.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                    window.chatData = msgs;
                    window.dispatchEvent(new Event('chat-updated'));
                });
            });

            // Mesaj Gönderme
            window.sendChatMessage = async (text, role, targetUser) => {
                await addDoc(chatColl, {
                    text, from: role, userId: targetUser || window.currentUserId,
                    timestamp: serverTimestamp(), read: false
                });
            };

        } catch(e) { console.error("Firebase Hatası:", e); }

        // --- 3. DÖVİZ KURLARI (TCMB) ---
        window.rates = { TRY: 1, USD: 36.5, EUR: 38.2 }; // Varsayılan (Yedek)
        
        async function fetchRates() {
            try {
                // AllOrigins Proxy ile TCMB XML çekme
                const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent('https://www.tcmb.gov.tr/kurlar/today.xml')}`);
                const text = await res.text();
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, "text/xml");
                
                const usd = parseFloat(xml.querySelector('Currency[Kod="USD"] ForexSelling').textContent);
                const eur = parseFloat(xml.querySelector('Currency[Kod="EUR"] ForexSelling').textContent);
                
                if(usd && eur) {
                    window.rates.USD = usd;
                    window.rates.EUR = eur;
                    document.getElementById('rate-ticker').innerHTML = `
                        <span class="text-green-400 font-bold"><i class="fa-solid fa-tower-broadcast"></i> TCMB Canlı:</span> 
                        USD: ${usd.toFixed(2)}₺ | EUR: ${eur.toFixed(2)}₺
                    `;
                    window.dispatchEvent(new Event('db-updated')); // Fiyatları yenile
                }
            } catch(e) {
                document.getElementById('rate-ticker').innerHTML = `<span class="text-orange-400">Kur Güncellenemedi (Offline)</span>`;
            }
        }
        fetchRates();

    </script>

    <!-- ==================== UI APP ==================== -->
    <div id="client-app" class="flex-col flex min-h-screen">
        <header class="relative mb-24">
            <div class="bg-marine-dark pb-16 pt-4 text-white">
                <div class="container mx-auto px-4">
                    <!-- Top Bar -->
                    <div class="flex flex-col md:flex-row justify-between items-center border-b border-white/10 pb-3 mb-4 text-xs md:text-sm">
                        <div class="flex items-center gap-4">
                            <div class="flex items-center bg-white/10 px-3 py-1 rounded-full backdrop-blur-sm border border-white/10" id="rate-ticker">
                                Yükleniyor...
                            </div>
                            <div class="flex items-center">
                                <span class="mr-2 opacity-70">Para Birimi:</span>
                                <select id="currency-selector" onchange="changeCurrency(this.value)" class="bg-transparent font-bold outline-none cursor-pointer text-marine-accent">
                                    <option value="TRY" class="text-black">TRY (₺)</option>
                                    <option value="USD" class="text-black">USD ($)</option>
                                    <option value="EUR" class="text-black">EUR (€)</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-2 md:mt-0">
                            <button onclick="toggleAdminPanel()" class="hover:text-marine-accent transition font-bold"><i class="fa-solid fa-user-gear"></i> Yönetim Paneli</button>
                        </div>
                    </div>

                    <!-- Navbar -->
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <nav class="flex gap-6 font-bold tracking-wide text-sm">
                            <a href="#" onclick="router('home')" class="hover:text-marine-accent py-2">ANA SAYFA</a>
                            <a href="#" onclick="router('products')" class="hover:text-marine-accent py-2">ÜRÜNLER</a>
                            <a href="#" onclick="router('contact')" class="hover:text-marine-accent py-2">İLETİŞİM</a>
                        </nav>
                        <div class="flex items-center gap-4 w-full md:w-auto justify-end">
                            <div class="relative group w-full md:w-64">
                                <input type="text" placeholder="Ürün ara..." onkeyup="handleSearch(this.value)" class="w-full bg-white/10 border border-transparent focus:border-marine-accent focus:bg-white focus:text-marine-dark rounded-full px-4 py-2 text-sm outline-none placeholder-gray-400 text-white">
                                <div id="search-results" class="absolute top-full left-0 w-full bg-white text-marine-dark mt-2 rounded-lg shadow-xl z-50 hidden max-h-60 overflow-y-auto"></div>
                            </div>
                            <div onclick="router('cart')" class="relative cursor-pointer group">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-marine-dark group-hover:bg-marine-accent group-hover:text-white transition shadow-lg">
                                    <i class="fa-solid fa-basket-shopping"></i>
                                </div>
                                <span id="cart-badge" class="absolute -top-1 -right-1 bg-marine-accent text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-marine-dark">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="header-curve"></div>
            <div class="logo-area" onclick="router('home')">
                <div class="text-center leading-none">
                    <i class="fa-solid fa-anchor text-4xl text-marine-dark mb-1"></i>
                    <div class="font-black text-marine-dark text-sm">MARIN</div>
                    <div class="font-bold text-marine-accent text-[10px]">EKIPMAN</div>
                </div>
            </div>
        </header>

        <main id="main-content" class="flex-grow container mx-auto px-4 pb-12 fade-in"></main>

        <footer class="bg-marine-dark text-white pt-16 pb-8 border-t-4 border-marine-accent mt-auto text-center text-sm text-gray-400">
            &copy; 2025 MarinEkipman. Profesyonel Denizcilik Çözümleri.
        </footer>

        <!-- CHAT -->
        <div class="chat-widget-btn" onclick="toggleChat()"><i class="fa-regular fa-comments"></i></div>
        <div id="chat-box" class="chat-box">
            <div class="bg-marine-dark text-white p-4 font-bold flex justify-between items-center">
                <div class="flex items-center gap-2"><div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div> Canlı Destek</div>
                <button onclick="toggleChat()"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="chat-messages" class="flex-grow bg-gray-50 p-4 overflow-y-auto space-y-3"></div>
            <div class="p-3 border-t bg-white flex gap-2">
                <input id="chat-input" class="flex-grow border rounded-full px-4 py-2 text-sm outline-none" placeholder="Mesajınız..." onkeypress="if(event.key==='Enter') sendUserMsg()">
                <button onclick="sendUserMsg()" class="bg-marine-accent text-white w-10 h-10 rounded-full"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- ==================== ADMIN APP ==================== -->
    <div id="admin-app" class="fixed inset-0 bg-gray-900 z-[100] hidden flex">
        <aside class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col text-white hidden md:flex" id="admin-sidebar">
            <div class="p-6 border-b border-gray-700"><h2 class="text-2xl font-black text-marine-accent">YÖNETİM</h2><p class="text-xs text-gray-400">Hibrit Sistem v4.0</p></div>
            <nav class="flex-grow p-4 space-y-2">
                <button onclick="adminRouter('dash')" class="w-full text-left p-3 rounded hover:bg-gray-700 flex items-center gap-3"><i class="fa-solid fa-chart-line"></i> Özet</button>
                <button onclick="adminRouter('products')" class="w-full text-left p-3 rounded hover:bg-gray-700 flex items-center gap-3"><i class="fa-solid fa-box"></i> Ürünler</button>
                <button onclick="adminRouter('campaigns')" class="w-full text-left p-3 rounded hover:bg-gray-700 flex items-center gap-3"><i class="fa-solid fa-tags"></i> Kampanyalar</button>
                <button onclick="adminRouter('chat')" class="w-full text-left p-3 rounded hover:bg-gray-700 flex items-center gap-3"><i class="fa-solid fa-comments"></i> Mesajlar</button>
                <button onclick="location.reload()" class="w-full text-left p-3 rounded hover:bg-red-900 mt-10 text-red-400"><i class="fa-solid fa-door-open"></i> Çıkış</button>
            </nav>
        </aside>
        <main class="flex-grow bg-gray-900 text-white p-8 overflow-y-auto relative w-full">
            <button onclick="document.getElementById('admin-sidebar').classList.toggle('hidden')" class="md:hidden absolute top-4 left-4 bg-gray-800 p-2 rounded text-white z-50"><i class="fa-solid fa-bars"></i></button>
            <div id="admin-login" class="fixed inset-0 bg-gray-900 z-[110] flex items-center justify-center">
                <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-96 border border-gray-700 text-center">
                    <i class="fa-solid fa-user-shield text-5xl text-marine-accent mb-4"></i>
                    <h2 class="text-xl font-bold mb-6">Yönetici Girişi</h2>
                    <input type="password" id="admin-pass" placeholder="Şifre: admin" class="w-full bg-gray-700 border border-gray-600 p-3 rounded mb-4 text-white outline-none">
                    <button onclick="checkAdminLogin()" class="w-full bg-marine-accent py-3 rounded font-bold">Giriş Yap</button>
                </div>
            </div>
            <div id="admin-content-area"></div>
        </main>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    
    <script>
        // --- CLIENT LOGIC ---
        let currentRoute = 'home';
        let activeCurrency = 'TRY';
        let cart = [];
        let adminChatUser = null;

        // Fiyat Hesaplama (Kur + Kampanya)
        function calcPrice(product) {
            let rate = 1;
            if (product.currency === 'USD') rate = window.rates.USD;
            if (product.currency === 'EUR') rate = window.rates.EUR;
            
            let tryPrice = product.basePrice * rate;

            // Kampanya Kontrolü
            let discount = 0;
            let campaignName = "";
            window.localDB.campaigns.forEach(camp => {
                if (camp.type === 'category' && camp.target === product.category) {
                    if (camp.discount > discount) { discount = camp.discount; campaignName = camp.name; }
                }
                if (camp.type === 'brand' && camp.target === product.brand) {
                    if (camp.discount > discount) { discount = camp.discount; campaignName = camp.name; }
                }
            });

            const finalTry = tryPrice * ((100 - discount) / 100);
            
            // Gösterim Kuru
            let displayPrice = finalTry;
            let symbol = '₺';
            if (activeCurrency === 'USD') { displayPrice = finalTry / window.rates.USD; symbol = '$'; }
            if (activeCurrency === 'EUR') { displayPrice = finalTry / window.rates.EUR; symbol = '€'; }

            return {
                amount: displayPrice,
                symbol: symbol,
                formatted: new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(displayPrice) + ' ' + symbol,
                discount: discount,
                campaignName: campaignName
            };
        }

        // Routing
        function router(page) {
            currentRoute = page;
            window.scrollTo(0,0);
            const main = document.getElementById('main-content');
            
            if (page === 'home') renderHome(main);
            else if (page === 'products') renderProducts(main);
            else if (page === 'cart') renderCart(main);
            else if (page === 'contact') renderContact(main);
        }

        function renderHome(el) {
            const banners = window.localDB.banners;
            const featured = window.localDB.products.filter(p => p.isFeatured);

            let sliderHtml = banners.length ? `
                <div class="relative w-full h-[300px] md:h-[450px] rounded-2xl overflow-hidden shadow-2xl mb-12 group">
                    <img src="${banners[0].img}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-marine-dark/90 to-transparent flex flex-col justify-end p-8 md:p-16">
                        <h2 class="text-3xl md:text-5xl font-bold text-white mb-2 drop-shadow-md">${banners[0].title}</h2>
                        <p class="text-gray-200 text-lg md:text-xl mb-6 drop-shadow">${banners[0].sub}</p>
                        <button onclick="router('products')" class="w-fit bg-marine-accent text-white px-8 py-3 rounded-lg font-bold hover:bg-white hover:text-marine-accent transition">İNCELE</button>
                    </div>
                </div>` : '';

            el.innerHTML = `
                ${sliderHtml}
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-marine-dark border-l-4 border-marine-accent pl-3">Vitrin Ürünleri</h3>
                    <a href="#" onclick="router('products')" class="text-sm font-bold text-marine-blue hover:underline">Tümünü Gör</a>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${featured.length ? featured.map(p => productCard(p)).join('') : '<div class="col-span-4 text-center py-10">Ürün Yok</div>'}
                </div>
            `;
        }

        function renderProducts(el) {
            const products = window.localDB.products;
            el.innerHTML = `
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="w-full md:w-1/4">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 sticky top-4">
                            <h4 class="font-bold border-b pb-3 mb-4 text-marine-dark">Kategoriler</h4>
                            <ul class="space-y-2">
                                <li class="text-marine-accent font-bold cursor-pointer" onclick="router('products')">Tümü</li>
                                ${window.localDB.categories.map(c => `<li class="text-gray-600 hover:text-marine-accent cursor-pointer">${c}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    <div class="w-full md:w-3/4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${products.map(p => productCard(p)).join('')}
                    </div>
                </div>
            `;
        }

        function productCard(p) {
            const price = calcPrice(p);
            return `
            <div class="product-card group flex flex-col h-full">
                ${p.isFeatured ? '<div class="featured-badge">VİTRİN</div>' : ''}
                ${price.discount > 0 ? `<div class="discount-badge">%${price.discount}</div>` : ''}
                <div class="h-56 p-6 flex items-center justify-center bg-white">
                    <img src="${p.img}" class="max-h-full max-w-full object-contain group-hover:scale-110 transition duration-500">
                </div>
                <div class="p-5 border-t border-gray-100 flex-grow flex flex-col bg-white">
                    <div class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1">${p.brand}</div>
                    <h3 class="font-bold text-marine-dark text-sm mb-2 line-clamp-2">${p.name}</h3>
                    <div class="mt-auto flex justify-between items-end pt-4">
                        <div>
                            ${price.discount > 0 ? `<div class="text-xs text-green-500 font-bold mb-1">${price.campaignName}</div>` : ''}
                            <div class="text-xl font-bold text-marine-blue">${price.formatted}</div>
                        </div>
                        <button onclick="addToCart(${p.id})" class="w-10 h-10 rounded-full bg-gray-50 text-marine-dark hover:bg-marine-accent hover:text-white flex items-center justify-center transition shadow-sm border border-gray-200">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>`;
        }

        function addToCart(id) {
            const p = window.localDB.products.find(x => x.id === id);
            if(p) { cart.push(p); document.getElementById('cart-badge').innerText = cart.length; toastr.success("Eklendi"); }
        }

        function renderCart(el) {
            if(cart.length === 0) { el.innerHTML = '<div class="text-center py-20 text-gray-400">Sepet Boş</div>'; return; }
            el.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow max-w-3xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6">Teklif Listesi</h2>
                    ${cart.map((p,i) => `<div class="flex justify-between border-b py-2"><span>${p.name}</span><button onclick="cart.splice(${i},1);router('cart')" class="text-red-500">Sil</button></div>`).join('')}
                    <div class="mt-6">
                        <input id="q-info" class="border p-3 w-full rounded mb-2" placeholder="Ad Soyad ve Telefon">
                        <button onclick="toastr.success('Teklif talebi iletildi')" class="bg-marine-dark text-white w-full py-3 rounded font-bold">TEKLİF İSTE</button>
                    </div>
                </div>
            `;
        }

        function renderContact(el) {
            el.innerHTML = `<div class="bg-white p-12 text-center rounded-xl shadow max-w-xl mx-auto">
                <h1 class="text-3xl font-bold text-marine-dark mb-4">İletişim</h1>
                <p>0212 555 0000 | info@marin.com</p>
            </div>`;
        }

        function changeCurrency(v) { activeCurrency = v; router(currentRoute); }
        
        // --- CHAT LOGIC ---
        function toggleChat() {
            const b = document.getElementById('chat-box');
            b.style.display = b.style.display === 'flex' ? 'none' : 'flex';
            if(b.style.display === 'flex') renderChat();
        }
        function sendUserMsg() {
            const txt = document.getElementById('chat-input').value.trim();
            if(txt && window.sendChatMessage) {
                window.sendChatMessage(txt, 'user');
                document.getElementById('chat-input').value = '';
            }
        }
        function renderChat() {
            const div = document.getElementById('chat-messages');
            const msgs = window.chatData.filter(m => m.userId === window.currentUserId);
            div.innerHTML = msgs.map(m => `<div class="flex flex-col ${m.from==='user'?'items-end':'items-start'}"><div class="max-w-[85%] p-2 rounded text-sm mb-1 ${m.from==='user'?'bg-marine-blue text-white':'bg-gray-200'}">${m.text}</div></div>`).join('');
            div.scrollTop = div.scrollHeight;
        }
        // Chat güncelleme listener
        window.addEventListener('chat-updated', () => {
            if(document.getElementById('chat-box').style.display === 'flex') renderChat();
            if(!document.getElementById('admin-app').classList.contains('hidden')) renderAdminChat();
        });
        window.addEventListener('db-updated', () => router(currentRoute));

        // --- ADMIN PANEL ---
        function toggleAdminPanel() { 
            const p = document.getElementById('admin-app');
            const l = document.getElementById('admin-login');
            if(p.classList.contains('hidden')) { p.classList.remove('hidden'); l.classList.remove('hidden'); }
            else p.classList.add('hidden');
        }
        function checkAdminLogin() {
            if(document.getElementById('admin-pass').value === 'admin') {
                document.getElementById('admin-login').classList.add('hidden');
                adminRouter('dash');
            } else toastr.error("Hatalı Şifre");
        }
        function adminRouter(page) {
            const area = document.getElementById('admin-content-area');
            if(page === 'dash') {
                area.innerHTML = `<h2 class="text-3xl font-bold mb-6">Özet</h2>
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-gray-800 p-6 rounded">Ürün Sayısı: ${window.localDB.products.length}</div>
                    <div class="bg-gray-800 p-6 rounded">Kampanyalar: ${window.localDB.campaigns.length}</div>
                </div>`;
            } else if (page === 'products') {
                const list = window.localDB.products.map(p => `
                    <div class="flex justify-between items-center bg-gray-800 p-3 rounded mb-2">
                        <div class="flex items-center gap-3"><img src="${p.img}" class="w-10 h-10 rounded"> <span>${p.name}</span></div>
                        <button onclick="window.localDB.products = window.localDB.products.filter(x=>x.id!=${p.id}); window.saveLocalDB(); adminRouter('products')" class="text-red-400">Sil</button>
                    </div>`).join('');
                area.innerHTML = `<h2 class="text-2xl font-bold mb-4">Ürünler</h2>
                <div class="mb-4 flex gap-2">
                    <input id="adm-p-name" placeholder="Ad" class="bg-gray-700 p-2 rounded text-white">
                    <input id="adm-p-price" placeholder="Fiyat" class="bg-gray-700 p-2 rounded text-white w-24">
                    <button onclick="addLocalProduct()" class="bg-green-600 px-4 rounded">Ekle</button>
                </div>
                ${list}`;
            } else if (page === 'campaigns') {
                const list = window.localDB.campaigns.map((c,i) => `
                    <div class="flex justify-between bg-gray-800 p-3 rounded mb-2">
                        <span>${c.name} (${c.target} - %${c.discount})</span>
                        <button onclick="window.localDB.campaigns.splice(${i},1); window.saveLocalDB(); adminRouter('campaigns')" class="text-red-400">Sil</button>
                    </div>`).join('');
                area.innerHTML = `<h2 class="text-2xl font-bold mb-4">Kampanyalar</h2>
                <div class="mb-4 flex gap-2">
                    <select id="cmp-type" class="bg-gray-700 p-2 rounded text-white"><option value="category">Kategori</option><option value="brand">Marka</option></select>
                    <input id="cmp-target" placeholder="Hedef (Örn: Giyim)" class="bg-gray-700 p-2 rounded text-white">
                    <input id="cmp-disc" placeholder="%" class="bg-gray-700 p-2 rounded text-white w-16">
                    <button onclick="addCampaign()" class="bg-green-600 px-4 rounded">Ekle</button>
                </div>
                ${list}`;
            } else if (page === 'chat') {
                renderAdminChat(area);
            }
        }

        function addLocalProduct() {
            const name = document.getElementById('adm-p-name').value;
            const price = document.getElementById('adm-p-price').value;
            if(name && price) {
                window.localDB.products.push({
                    id: Date.now(), name, basePrice: parseFloat(price), currency: 'TRY', stock: 10, category: 'Genel', brand: 'Diğer', img: 'https://placehold.co/300', desc: '', isFeatured: false
                });
                window.saveLocalDB();
                adminRouter('products');
            }
        }

        function addCampaign() {
            const type = document.getElementById('cmp-type').value;
            const target = document.getElementById('cmp-target').value;
            const disc = document.getElementById('cmp-disc').value;
            if(target && disc) {
                window.localDB.campaigns.push({ type, target, discount: parseFloat(disc), name: target + ' İndirimi' });
                window.saveLocalDB();
                adminRouter('campaigns');
            }
        }

        function renderAdminChat(domArea) {
            const area = domArea || document.getElementById('admin-content-area');
            const groups = {};
            window.chatData.forEach(m => { if(!groups[m.userId]) groups[m.userId]=[]; groups[m.userId].push(m); });
            
            const usersHtml = Object.keys(groups).map(u => `<div onclick="adminChatUser='${u}'; renderAdminChat()" class="p-3 bg-gray-800 mb-2 cursor-pointer ${adminChatUser===u?'border-l-4 border-marine-accent':''}">${u.substr(0,8)}...</div>`).join('');
            
            let msgsHtml = '<div class="text-gray-500">Seçiniz</div>';
            if(adminChatUser && groups[adminChatUser]) {
                msgsHtml = groups[adminChatUser].map(m => `<div class="mb-2 ${m.from==='admin'?'text-right text-marine-light':'text-left'}">${m.text}</div>`).join('');
            }

            area.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Mesajlar (Firebase)</h2>
                <div class="flex h-[500px] border border-gray-700">
                    <div class="w-1/4 border-r border-gray-700 p-2 overflow-y-auto">${usersHtml}</div>
                    <div class="w-3/4 flex flex-col p-4 bg-gray-800">
                        <div class="flex-grow overflow-y-auto mb-2">${msgsHtml}</div>
                        <div class="flex gap-2">
                            <input id="adm-chat-in" class="flex-grow bg-gray-700 p-2 rounded text-white">
                            <button onclick="sendAdminChat()" class="bg-marine-accent px-4 rounded">Yolla</button>
                        </div>
                    </div>
                </div>`;
        }

        function sendAdminChat() {
            const txt = document.getElementById('adm-chat-in').value;
            if(txt && adminChatUser) {
                window.sendChatMessage(txt, 'admin', adminChatUser);
            }
        }

        // Başlangıç
        document.addEventListener('DOMContentLoaded', () => {
            router('home');
        });

    </script>
</body>
</html>
